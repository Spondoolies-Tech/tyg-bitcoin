#!/bin/sh
#
# Handle SPI.
#


MINERGATE_CMD="nohup chrt -f 90 /usr/local/bin/miner_gate_arm > /dev/null 2>&1"
CGMINER_CMD="nohup /usr/local/bin/cgminer --config /etc/cgminer.conf"
WATCHDOG_FILE="/var/run/dont_reboot"
NVM_LOG="/mnt/mmc-config/log/mining-watchdog-reboot.log"
SYSLOG_FILE="/mnt/mmc-config/log/messages"
MAX_NVM_LOG_SIZE=5000
export PATH=$PATH:/usr/local/bin:/bin


reboot_miner_safe() {
	NVM_LOG_SIZE=$(du -a "$NVM_LOG" | cut -f 1)
	if [ $NVM_LOG_SIZE -ge $MAX_NVM_LOG_SIZE ]; then
		echo "removing huge log file"
		rm $NVM_LOG
	fi

	echo "Not mining, reboot!"
	echo "-----------------------" >> $NVM_LOG
	echo -e "Not mining, reboot!" >> $NVM_LOG
	echo "-----------------------" >> $NVM_LOG
	echo `date` >> $NVM_LOG
	dmesg >> $NVM_LOG
	echo "-----------------------" >> $NVM_LOG
	ps >> $NVM_LOG
	echo "-----------------------" >> $NVM_LOG
	cat /proc/meminfo >> $NVM_LOG
	echo "-----------------------" >> $NVM_LOG
	cat /var/log/asics >> $NVM_LOG
	echo "-----------------------" >> $NVM_LOG
	pid1=`cat /var/run/miner_gate_arm_watchdog.pid`
	pid3=`cat /var/run/miner_gate_arm.pid`
	kill $pid3
	sleep 1
	kill $pid3
	sync
	sleep 5
	sync
        reboot
}


test_free_memory()
{
	FREE_MEM=`awk '/MemFree/ {printf( "%.2d\n", $2 / 1024 )}' /proc/meminfo`
	[ $FREE_MEM -lt 100 ] && reboot_miner_safe 
}


forever_mining_watchdog()
{
	while true
	do
		#sleep for 5 minutes
		sleep 300
		if [ -f $WATCHDOG_FILE ] 
		then
			#echo "Removed watchdog file."
			rm $WATCHDOG_FILE
		else
			reboot_miner_safe 
		fi
	done
	
}



miner_gate_arm_watchdog () {
	$MINERGATE_CMD &
	echo $! > /var/run/miner_gate_arm.pid
	sleep 5
	$CGMINER_CMD &
	echo $! > /var/run/cgminer_arm.pid
	forever_mining_watchdog &
	echo $! > /var/run/fmw.pid

	while true; do
		test_free_memory
		pidm=`cat /var/run/miner_gate_arm.pid`
		if [ ! -e /proc/$pidm -a /proc/$pidm/exe ]; then
			echo "Minergate died and restarted"
			$MINERGATE_CMD &
			echo $! > /var/run/miner_gate_arm.pid
		fi

		pidc=`cat /var/run/cgminer_arm.pid`
		if [ ! -e /proc/$pidc -a /proc/$pidc/exe ]; then
			echo "Cgminer died and restarted"
			$CGMINER_CMD &
			echo $! > /var/run/cgminer_arm.pid
		fi
		sleep 3;
	done

}




start_mg() {
	
		if [ -f "/var/run/miner_gate_arm.pid" ]; then
			echo "minergate is already running"
		else
			miner_gate_arm_watchdog &
			echo $! > /var/run/miner_gate_arm_watchdog.pid
		fi
}


stop_mg() {
		if [ ! -f "/var/run/miner_gate_arm_watchdog.pid" ]
		then
			echo "Mining manager not running"
		else
			pid1=`cat /var/run/miner_gate_arm_watchdog.pid`
			pid2=`cat /var/run/cgminer_arm.pid`
			pid3=`cat /var/run/miner_gate_arm.pid`
			pid4=`cat /var/run/fmw.pid`
			kill $pid1
			kill $pid4
			kill $pid2
			kill $pid3
			rm /var/run/miner_gate_arm_watchdog.pid
			rm /var/run/miner_gate_arm.pid
			rm /var/run/cgminer_arm.pid
			rm /var/run/fmw.pid
		fi
}



case "$1" in
start)
	# bullshit
	NORMALBOOT=1

	#	mount /mnt/sd-boot
	#	mount /mnt/mmc-config
	#	mount /mnt/mmc-boot
	start_mg
	;;
stop)
	stop_mg
	;;
restart|reload)
	"$0" stop
	sleep 1
	"$0" start
	;;
*)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?




